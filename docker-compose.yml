
services:
  db:
    image: mysql:8.0
    container_name: commerce-mysql
    env_file:
      - .env
    ports:
      - "${MYSQL_PORT}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: Asia/Seoul
    command:
      - --default-authentication-plugin=mysql_native_password
    volumes:
      - db-data:/var/lib/mysql

  redis:
    image: redis:7.2-alpine
    container_name: commerce-redis
    ports:
      - "${REDIS_PORT}:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data

  # Zookeeper - Kafka 클러스터 메타데이터 관리 및 브로커 조정
  # 카프카 브로커의 상태 정보, 토픽 설정, 파티션 리더 정보 등을 저장
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.1
    container_name: commerce-zookeeper
    env_file:
      - .env
    environment:
      # Zookeeper 클라이언트 접속 포트
      ZOOKEEPER_CLIENT_PORT: ${ZOOKEEPER_PORT}
      # Zookeeper 내부 타임 단위 (밀리초) - 세션 타임아웃, 하트비트 등의 기준
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "${ZOOKEEPER_PORT}:2181"
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data  # Zookeeper 데이터 영속화
      - zookeeper-logs:/var/lib/zookeeper/log   # Zookeeper 트랜잭션 로그 영속화
    networks:
      - commerce-network
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 2181 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Kafka Broker - 메시지 브로커 (이벤트 발행/구독 처리)
  # Producer로부터 메시지를 받아 토픽에 저장하고, Consumer에게 전달
  kafka-broker:
    image: confluentinc/cp-kafka:7.5.1
    container_name: commerce-kafka-broker
    env_file:
      - .env
    depends_on:
      zookeeper: # Zookeeper가 먼저 실행되어야 함
        condition: service_healthy
    ports:
      # 외부(호스트)에서 접속하는 포트 - Spring Boot 애플리케이션이 사용
      - "${EXTERNAL_KAFKA_PORT}:9092"
      # 내부(Docker 네트워크)에서 접속하는 포트 - 컨테이너간 통신용
      - "${KAFKA_INTERNAL_PORT}:29092"
    environment:
      # 브로커 ID (클러스터 내 고유 식별자)
      KAFKA_BROKER_ID: 1
      # Zookeeper 접속 정보
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      
      # 리스너 설정 - 다중 리스너 지원 (내부/외부 통신 분리)
      # PLAINTEXT://kafka:29092 -> 컨테이너 간 통신 (docker network 내부)
      # PLAINTEXT_HOST://localhost:9092 -> 호스트 머신에서 접속 (개발 환경)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker:29092,PLAINTEXT_HOST://localhost:9092
      
      # 리스너별 보안 프로토콜 매핑 (현재는 암호화 없는 PLAINTEXT 사용)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT

      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:909
      
      # 브로커 간 통신에 사용할 리스너
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      
      # __consumer_offsets 토픽의 복제 계수 (단일 브로커이므로 1)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      
      # 토픽 자동 생성 허용 (개발 환경 편의용, 운영에서는 false 권장)
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      
      # 로그 보관 설정
      KAFKA_LOG_RETENTION_HOURS: 168  # 7일간 메시지 보관
      KAFKA_LOG_SEGMENT_BYTES: 1073741824  # 1GB 단위로 로그 세그먼트 분할
      
      # 성능 튜닝 (단일 브로커 기준)
      KAFKA_NUM_NETWORK_THREADS: 3  # 네트워크 요청 처리 스레드 수
      KAFKA_NUM_IO_THREADS: 8  # 디스크 I/O 처리 스레드 수
    volumes:
      - kafka-data:/var/lib/kafka/data  # Kafka 메시지 데이터 영속화
    networks:
      - commerce-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka UI - 카프카 클러스터 모니터링 및 관리 웹 인터페이스 (개발/운영 편의용)
  # 토픽, 메시지, 컨슈머 그룹, 브로커 상태 등을 웹에서 확인 가능
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: commerce-kafka-ui
    env_file:
      - .env
    depends_on:
      - kafka-broker
    ports:
      - "${KAFKA_UI_PORT}:8080"  # http://localhost:8989 로 접속
    environment:
      # Kafka UI에서 표시할 클러스터 이름
      KAFKA_CLUSTERS_0_NAME: commerce-local
      # Kafka 브로커 접속 정보 (Docker 네트워크 내부 주소 사용)
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-broker:29092
      # Zookeeper 접속 정보 (토픽 설정 등 확인용)
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - commerce-network

# Docker 네트워크 정의 - 컨테이너 간 통신을 위한 격리된 네트워크
networks:
  commerce-network:
    driver: bridge

# 데이터 영속성을 위한 볼륨 정의
# 컨테이너 재시작/삭제시에도 데이터 유지
volumes:
  db-data:          # MySQL 데이터
  redis-data:       # Redis 데이터
  zookeeper-data:   # Zookeeper 상태 데이터
  zookeeper-logs:   # Zookeeper 트랜잭션 로그
  kafka-data:       # Kafka 메시지 및 로그
